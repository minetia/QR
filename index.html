<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>정밀 QR 스캐너 v2.5</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* 1. 전체 화면 레이아웃 설정 */
        body { margin: 0; padding: 0; background-color: #000; font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        #reader-container { position: relative; flex: 1; width: 100%; }
        #reader { width: 100%; height: 100%; }
        
        /* 2. 스캔 오버레이 (가이드라인 및 텍스트) */
       .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; }
       .scan-text { color: #fff; font-size: 18px; margin-bottom: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
       .corner-box { position: relative; width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.1); border-radius: 20px; }
        
        /* 모서리 가이드 표시 */
       .corner { position: absolute; width: 40px; height: 40px; border-color: #fff; border-style: solid; border-width: 0; }
       .top-left { top: -2px; left: -2px; border-top-width: 4px; border-left-width: 4px; border-top-left-radius: 20px; }
       .top-right { top: -2px; right: -2px; border-top-width: 4px; border-right-width: 4px; border-top-right-radius: 20px; }
       .bottom-left { bottom: -2px; left: -2px; border-bottom-width: 4px; border-left-width: 4px; border-bottom-left-radius: 20px; }
       .bottom-right { bottom: -2px; right: -2px; border-bottom-width: 4px; border-right-width: 4px; border-bottom-right-radius: 20px; }

        /* 3. 하단 컨트롤 바 */
       .controls { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; gap: 40px; z-index: 20; }
       .icon-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
       .icon-btn svg { fill: white; width: 28px; height: 28px; }
        
        /* 알림 메시지 */
        #status-msg { position: absolute; top: 15%; width: 100%; text-align: center; color: #ffeb3b; z-index: 20; font-size: 14px; }
    </style>
</head>
<body>

    <div id="reader-container">
        <div id="reader"></div>
        <div id="status-msg">화면을 눌러 스캐너를 시작하세요</div>
        
        <div class="overlay">
            <div class="scan-text">QR 코드를 찾는 중입니다.</div>
            <div class="corner-box">
                <div class="corner top-left"></div>
                <div class="corner top-right"></div>
                <div class="corner bottom-left"></div>
                <div class="corner bottom-right"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="icon-btn" onclick="toggleFlash()">
            <svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
        </button>
        <button class="icon-btn" onclick="document.getElementById('file-input').click()">
            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2.9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
        </button>
    </div>

    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="scanFromFile(event)">

    <script>
        let scanner;
        let isBusy = false;
        let torchOn = false;

        // 1. 스캐너 초기화 및 자동 시작 [3, 4]
        async function startEngine() {
            if (isBusy) return;
            isBusy = true;
            document.getElementById('status-msg').innerText = "카메라 연결 중...";

            try {
                if (scanner) await scanner.stop();
                scanner = new Html5Qrcode("reader");

                const config = {
                    fps: 25, 
                    qrbox: { width: 260, height: 260 }, // 가이드 박스와 일치시킴
                    aspectRatio: 1.0
                };

                // 고해상도 후면 카메라 우선 시도
                await scanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess
                );

                document.getElementById('status-msg').innerText = "";
                // iOS 26 등 최신 환경 대응을 위한 포커스 명령 
                const track = scanner.getRunningTrackCapabilities();
                if (track.focusMode) {
                    await scanner.applyVideoConstraints({ advanced: [{ focusMode: "continuous" }] });
                }
            } catch (err) {
                document.getElementById('status-msg').innerText = "오류: " + (err.name |

| err);
                console.error(err);
            } finally {
                isBusy = false;
            }
        }

        function onScanSuccess(text) {
            // 성공 시 진동 및 결과 알림 [2]
            if (navigator.vibrate) navigator.vibrate(100);
            alert("인식된 데이터: " + text);
        }

        // 2. 플래시 제어 (안드로이드 크롬 권장) 
        async function toggleFlash() {
            if (!scanner) return;
            try {
                torchOn =!torchOn;
                await scanner.applyVideoConstraints({
                    advanced: [{ torch: torchOn }]
                });
            } catch (e) {
                alert("이 기기는 플래시 제어를 지원하지 않습니다.");
            }
        }

        // 3. 갤러리 파일 스캔
        async function scanFromFile(event) {
            const file = event.target.files;
            if (!file ||!scanner) return;
            try {
                const result = await scanner.scanFile(file, true);
                onScanSuccess(result);
            } catch (err) {
                alert("이미지에서 QR 코드를 찾을 수 없습니다.");
            }
        }

        // 화면 로드 시 또는 클릭 시 시작
        window.addEventListener('click', () => {
            if (!scanner ||!scanner.isScanning) startEngine();
        }, { once: true });
    </script>
</body>
</html>
