<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>정밀 QR 스캐너 v2.7</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #000; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #reader { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
       .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; display: flex; flex-direction: column; align-items: center; justify-content: center; }
       .scan-text { color: white; font-size: 18px; margin-bottom: 30px; text-shadow: 0 2px 4px #000; font-weight: bold; }
       .guide-box { width: 260px; height: 260px; border: 1px solid rgba(255,255,255,0.2); border-radius: 30px; position: relative; }
       .corner { position: absolute; width: 50px; height: 50px; border: 5px solid white; border-radius: 15px; }
       .tl { top: -5px; left: -5px; border-right: 0; border-bottom: 0; }
       .tr { top: -5px; right: -5px; border-left: 0; border-bottom: 0; }
       .bl { bottom: -5px; left: -5px; border-right: 0; border-top: 0; }
       .br { bottom: -5px; right: -5px; border-left: 0; border-top: 0; }
       .ui-panel { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; gap: 40px; z-index: 10; }
       .icon-btn { width: 65px; height: 65px; background: rgba(255,255,255,0.25); border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
       .icon-btn svg { fill: white; width: 30px; height: 30px; }
        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; }
       .start-btn { padding: 15px 40px; background: #007bff; color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,123,255,0.5); }
    </style>
</head>
<body>

    <div id="reader"></div>
    
    <div id="start-overlay">
        <button class="start-btn" onclick="activateScanner()">스캐너 시작하기</button>
        <p style="color: #ccc; margin-top: 15px; font-size: 14px;">카메라 권한을 허용해 주세요</p>
    </div>

    <div class="overlay">
        <div class="scan-text">QR 코드를 찾는 중입니다.</div>
        <div class="guide-box">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
        </div>
    </div>

    <div class="ui-panel">
        <button class="icon-btn" onclick="toggleTorch()">
            <svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
        </button>
        <button class="icon-btn" onclick="document.getElementById('file-api').click()">
            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2.9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
        </button>
    </div>

    <input type="file" id="file-api" accept="image/*" style="display:none" onchange="scanLocalFile(event)">

    <script>
        let html5QrCode;
        let isActive = false;
        let isTorchOn = false;

        async function activateScanner() {
            if (isActive) return;
            isActive = true;
            document.getElementById('start-overlay').style.display = 'none';

            try {
                // 이전 세션이 남아있을 경우를 대비해 1초 대기 후 초기화
                await new Promise(r => setTimeout(r, 500));
                html5QrCode = new Html5Qrcode("reader");

                const config = {
                    fps: 20,
                    qrbox: { width: 260, height: 260 },
                    // [핵심] 안드로이드 크롬의 특정 버그(검은 화면)를 피하기 위해 네이티브 바코드 감지기 사용 안 함
                    experimentalFeatures: { useBarCodeDetectorIfSupported: false }
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => {
                        if (navigator.vibrate) navigator.vibrate(100);
                        alert("인식 결과: " + decodedText);
                    }
                );

                // iOS 26 등 최신 OS에서 인식이 멈추는 현상 방지를 위한 리셋 [1]
                const capabilities = html5QrCode.getRunningTrackCapabilities();
                if (capabilities.focusMode) {
                    await html5QrCode.applyVideoConstraints({ advanced: [{ focusMode: "continuous" }] });
                }

            } catch (err) {
                console.error(err);
                alert("실패: 카메라가 다른 앱에서 사용 중이거나 보안 설정이 되어있지 않습니다.");
                document.getElementById('start-overlay').style.display = 'flex';
                isActive = false;
            }
        }

        async function toggleTorch() {
            if (!html5QrCode) return;
            try {
                isTorchOn =!isTorchOn;
                await html5QrCode.applyVideoConstraints({ advanced: });
            } catch (e) {
                alert("이 기기는 플래시 제어를 지원하지 않습니다.");
            }
        }

        async function scanLocalFile(event) {
            const files = event.target.files;
            if (files.length === 0 ||!html5QrCode) return;
            try {
                const result = await html5QrCode.scanFile(files, true);
                alert("이미지 인식 결과: " + result);
            } catch (err) {
                alert("QR 코드를 찾을 수 없습니다.");
            }
        }
    </script>
</body>
</html>
